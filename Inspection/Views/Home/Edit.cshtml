@model Inspection.ViewModels.InpectionViewModel

@{
    ViewBag.Title = "Edit";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style type="text/css">
    body {
        font-size: 15px;
    }
    /*.OnChange {
            display: none;
    }*/
</style>
<script src="https://cdn.jsdelivr.net/jquery.validation/1.16.0/jquery.validate.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.0/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.0/jquery-ui.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="~/Scripts/jquery-ui.min.js"></script>
<script src="~/Scripts/bootstrap.min.js"></script>


<div class="container-fluid">
    @if (TempData["Success"] != null)
            {
        <div class="row">
            <div class="col-sm-12">
                <div class="alert alert-success" id="successMessage">@TempData["Success"]</div>
            </div>
        </div>

        <script type="text/javascript">
            $(document).ready(function () {
                setTimeout(function () {
                    $('#successMessage').slideUp(500);
                }, 5000);
            });
        </script>
    }
    <div class="row">
        <div class="col-sm-12">
            <div class="standardDetails standardForm">
                @using (Html.BeginForm("Edit", "Home", FormMethod.Post, new { enctype = "multipart/form-data", id = "inspectionViewResult" }))
                {
                    @*@Html.AntiForgeryToken()*@
                            <!-- Layer Section -->
                    <div class="layer-section">

                        <!-- Section Header -->
                        <div class="section-header">
                            <h2>Edit (@Model.Inspections.ID)</h2>
                        </div>
                        <!-- END Section Header -->
                        <!-- Section Content -->

                        @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                        @Html.HiddenFor(model => model.Inspections.ID, new { id = "InspectionID" })
                        <div class="section-content noMarginBottom">
                            <div class="row">
                                <div class="col-sm-6 col-md-8">@Html.Raw(ViewBag.Message)</div>
                                <div class="col-sm-3 col-md-2">
                                    @Html.ActionLink("Back to List", "Index", null, new { @class = "btn btn-transparent marginBottom-30" })
                                </div>
                                <div class="col-sm-3 col-md-2">
                                    <button id="InspectionButton" class="btn btn-primary">Update</button>
                                </div>
                            </div>
                            <div class="row-details">
                                @Html.HiddenFor(model => model.Inspections.ID)
                                <div class="detail-group">
                                    @Html.LabelFor(model => model.Inspections.SiteName, htmlAttributes: new { @class = "control-label col-md-2" })
                                    <div class="col-md-10">
                                        @Html.EditorFor(model => model.Inspections.SiteName, new { htmlAttributes = new { @class = "form-control" } })
                                        @Html.ValidationMessageFor(model => model.Inspections.SiteName, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                                <div class="detail-group">
                                    @Html.LabelFor(model => model.Inspections.SiteID, htmlAttributes: new { @class = "control-label col-md-2" })
                                    <div class="col-md-10">
                                        @Html.EditorFor(model => model.Inspections.SiteID, new { htmlAttributes = new { @class = "form-control" } })
                                        @Html.ValidationMessageFor(model => model.Inspections.SiteID, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                                <div class="detail-group">
                                    @Html.LabelFor(model => model.Inspections.AreaOfBusiness, htmlAttributes: new { @class = "control-label col-md-2" })
                                    <div class="col-md-10">
                                        @Html.EditorFor(model => model.Inspections.AreaOfBusiness, new { htmlAttributes = new { @class = "form-control" } })
                                        @Html.ValidationMessageFor(model => model.Inspections.AreaOfBusiness, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                                <div class="detail-group">
                                    @Html.LabelFor(model => model.Inspections.AreaInspected, htmlAttributes: new { @class = "control-label col-md-2" })
                                    <div class="col-md-10">
                                        @Html.EditorFor(model => model.Inspections.AreaInspected, new { htmlAttributes = new { @class = "form-control" } })
                                        @Html.ValidationMessageFor(model => model.Inspections.AreaInspected, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                                <div class="detail-group">
                                    @Html.LabelFor(model => model.Inspections.InspectedPerson, htmlAttributes: new { @class = "control-label col-md-2" })
                                    <div class="col-md-10">
                                        @Html.EditorFor(model => model.Inspections.InspectedPerson, new { htmlAttributes = new { @class = "form-control" } })
                                        @Html.ValidationMessageFor(model => model.Inspections.InspectedPerson, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                                @if (Model.Inspections.InspectionForm == "Activity")
                                {
                                    <div class="detail-group">
                                        @Html.LabelFor(model => model.Inspections.ActivityName, htmlAttributes: new { @class = "control-label col-md-2" })
                                        <div class="col-md-10">
                                            @Html.EditorFor(model => model.Inspections.ActivityName, new { htmlAttributes = new { @class = "form-control" } })
                                            @Html.ValidationMessageFor(model => model.Inspections.ActivityName, "", new { @class = "text-danger" })
                                        </div>
                                    </div>
                                }
                                <div class="detail-group">
                                    @Html.LabelFor(model => model.Inspections.InspectionDate, htmlAttributes: new { @class = "control-label col-md-2" })
                                    <div class="col-md-10">
                                        @Html.TextBoxFor(model => model.Inspections.InspectionDate, "{0:dd\\/MM\\/yyyy}", new { @class = "form-control" } )
                                        @Html.ValidationMessageFor(model => model.Inspections.InspectionDate, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                            <!-- END Layer Section -->
                 }
            </div>

            <!-- Layer Section -->
            <div class="layer-section">
                <!-- Section Header -->
                <div class="section-header">
                    <h2>Inspection Extention</h2>
                </div>
                <!-- END Section Header -->

                <div class="section-content">
                    <div class="detail-group full-width uploaded-images noMarginBottom">
                        <div class="row">
                            @if (Model.InspectionCompliantData.Count() != 0)
                            {
                                <table class="table table-striped table-dataTable alignLeft dataTable">
                                    <thead>
                                        <tr>
                                            <th hidden>InspectionCompliantID</th>
                                            <th>ID</th>
                                            <th>Question</th>
                                            <th>Answer</th>
                                            <th>Remarks</th>
                                            <th>Severity</th>
                                            <th>Assignee</th>
                                            <th>DueDate</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var @item in Model.InspectionCompliantData)
                                        {
                                            <tr role="row" class="odd">
                                                <td hidden>@item.InspectionCompliantID</td>
                                                <td>@item.CompliantNo</td>
                                                <td>@item.CompliantQues</td>
                                                <td>@item.Compliant</td>
                                                <td>@item.Remarks</td>
                                                <td>@item.Severity</td>
                                                <td>@item.Assignee</td>
                                                <td>@item.DueDate</td>
                                                <td>
                                                    <button id="editRowbtn" class="btn btn-primary editButton" style="font-size:12px;" onclick="EditRow(@item.InspectionCompliantID, '@item.CompliantNo', '@item.CompliantQues','@item.Compliant','@item.Remarks','@item.Severity','@item.Assignee','@item.DueDate')">Edit</button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            }
                        </div>
                    </div>
                </div>
            </div>
            <!-- Layer Section -->
            <!-- END Section Footer -->
        </div>
    </div>


    <div class="modal fade" id="paymentDetailList" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <label class="control-label" style="font-weight:bold" name="lblCompliantQues" id="lblCompliantQues" />
                </div>
                <label hidden id="id" style="font-weight:bold;"></label>
                <label hidden id="ComplaintNo" style="font-weight:bold;"></label>
                <div class="modal-body">
                    <form class="form-horizontal">
                        <div class="form-group">
                            <label class="col-md-3 control-label" id="lblCompliant">Answer</label>
                            <div class="col-md-6" style="margin:5px">
                                <select name="Compliant" id="Compliant">
                                    <option>Yes</option>
                                    <option>No</option>
                                    <option>N/A</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-md-3 control-label" id="lblRemarks">Remarks</label>
                            <div class="col-md-6" style="margin:5px">
                                <input type="text" class="form-control" name="Remarks" id="Remarks" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-md-3 control-label" id="lblSeverity">Severity</label>
                            <div class="col-md-6" style="margin:5px">
                                <select name="Severity" id="Severity">
                                    <option>Low</option>
                                    <option>High</option>
                                    <option>Medium</option>
                                    <option hidden>NULL</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-md-3 control-label" id="lblAssignee">Assignee</label>
                            <div class="col-md-6" style="margin:5px">
                                <input type="text" class="form-control" name="Assignee" id="Assignee" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-md-3 control-label" id="lblDueDate" >DueDate</label>
                            <div class="col-md-6" style="margin:5px">
                                <input type="text" value="dd/mm/yyyy" class="form-control" name="DueDate" id="DueDate" />
                            </div>
                        </div>
                    </form>

                    <button class="btn btn-primary" onclick="Update();">Save changes</button>
                </div>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript">

    if ($("#Inspections_FurtherActionRequired").val() === "Yes") {
        $(".OnChange").css("display", "block");
    }else {
        $(".OnChange").css("display", "none");
    }

    $(document).ready(function () {
        $('#Inspections_InspectionDate, #DueDate').datepicker({
            dateFormat: 'dd/mm/yy'
        });
    });   

    function EditRow(id, CompliantNo, CompliantQues, Compliant, Remarks, Severity, Assignee, DueDate) {
        $('#id').val(id);
        $('#ComplaintNo').val(CompliantNo);
        //var Dateformat = new Date(DueDate);
        //var curr_date = ("0" + Dateformat.getDate()).slice(-2);
        //var curr_month = ("0" + (Dateformat.getMonth() + 1)).slice(-2); //Months are zero based
        //var curr_year = Dateformat.getFullYear();
        //var dueDate = (curr_year + "-" + curr_month + "-" + curr_date);
        //var dueDate = (curr_date + "/" + curr_month + "/" + curr_year);

        $('#paymentDetailList')
            .find('[name="lblCompliantQues"]').text(CompliantQues).end()
            .find('[name="Compliant"]').val(Compliant).end()
            .find('[name="Remarks"]').val(Remarks).end()
            .find('[name="Severity"]').val(Severity).end()
            .find('[name="Assignee"]').val(Assignee).end()
            .find('[name="DueDate"]').val(DueDate).end();

        if (CompliantNo !== '101' && ($('#Compliant').val() === "Yes" || $('#Compliant').val() === "N/A")) {
            $('#Remarks,#lblRemarks').hide();
            $('#Severity,#lblSeverity').hide();
            $('#Assignee,#lblAssignee').hide();
            $('#DueDate,#lblDueDate').hide();
        }
        
        $("#paymentDetailList").modal('show');
    }


    $('#Compliant').on('change', function () {
        $(".error").remove();
        if ($('#lblCompliantQues').text() !== "Have any further actions been identified" && ($('#Compliant').val() === "Yes" || $('#Compliant').val() === "N/A")) {
            $('#Remarks,#lblRemarks').hide();
            $('#Severity,#lblSeverity').hide();
            $('#Assignee,#lblAssignee').hide();
            $('#DueDate,#lblDueDate').hide();
        }
        else if ($('#lblCompliantQues').text() === "Have any further actions been identified" && ($('#Compliant').val() == "No" || $('#Compliant').val() == "N/A")) {
            $('#Remarks,#lblRemarks').hide();
            $('#Severity,#lblSeverity').hide();
            $('#Assignee,#lblAssignee').hide();
            $('#DueDate,#lblDueDate').hide();
        }
        else {
            $('#Remarks,#lblRemarks').show();
            $('#Severity,#lblSeverity').show();
            $('#Assignee,#lblAssignee').show();
            $('#DueDate,#lblDueDate').show();
        }
    });

    //function for updating
    function Update() {
        
        $(".error").remove();

        if ($('#lblCompliantQues').text() === "Have any further actions been identified") {

            if ($('#Compliant').val() === "Yes" && ($('#Remarks').val() === "NULL" || $('#Remarks').val() === "")) {
                $('#Remarks').after('<span class="error" style="color:red;margin-left:5px;">This field is required</span>');


            }
            else if ($('#Compliant').val() === "Yes" && $('#Severity').val() === "NULL") {
                $('#Severity').after('<span class="error" style="color:red;margin-left:5px;">This field is required</span>');
            }
            else if ($('#Compliant').val() === "Yes" && ($('#Assignee').val() === "NULL" || $('#Assignee').val() === "")) {
                $('#Assignee').after('<span class="error" style="color:red;margin-left:5px;">This field is required</span>');
            }
            else if ($('#Compliant').val() === "Yes" && ($('#DueDate').val() === "NULL" || $('#DueDate').val() === "" || $('#DueDate').val() === "NaN-aN-aN" || $('#DueDate').val() === "aN/aN/NaN")) {
                $('#DueDate').after('<span class="error" style="color:red;margin-left:5px;">This field is required</span>');
            }
            else
            {

                var dueDate1 = $('#DueDate').val();
                if ($('#Compliant').val() === "No" || $('#Compliant').val() === "N/A") {
                    $('#Remarks').val("NULL");
                    $('#Severity').val("NULL");
                    $('#Assignee').val("NULL");
                    dueDate1 = "NULL";
                }

                var inspectionObj1 = {
                    id: $('#id').val(),
                    CompliantNo: $('#ComplaintNo').val(),
                    InspectionID: $('#InspectionID').val(),
                    Compliant: $('#Compliant').val(),
                    Remarks: $('#Remarks').val(),
                    Severity: $('#Severity').val(),
                    Assignee: $('#Assignee').val(),
                    DueDate: dueDate1
                };

                $.ajax({
                    url: "/Home/UpdateInspectionResult",
                    data: JSON.stringify(inspectionObj1),
                    type: "POST",
                    contentType: "application/json;charset=utf-8",
                    dataType: "json",
                    success: function (result) {

                        $("#paymentDetailList").modal('hide');
                        location.reload();
                        $('#Compliant').modal('hide');
                        $('#Remarks').val("");
                        $('#Severity').val("");
                        $('#Assignee').val("");
                        $('#DueDate').val("");
                    }
                });
            }
        }
        else
        {
           
            if ($('#Compliant').val() === "No" && ($('#Remarks').val() === "NULL" || $('#Remarks').val() === "")) {
                $('#Remarks').after('<span class="error" style="color:red;margin-left:5px;">This field is required</span>');
            }
            else if ($('#Compliant').val() === "No" && $('#Severity').val() === "NULL") {
                $('#Severity').after('<span class="error" style="color:red;margin-left:5px;">This field is required</span>');
            }
            else if ($('#Compliant').val() === "No" && ($('#Assignee').val() === "NULL" || $('#Assignee').val() === "")) {
                $('#Assignee').after('<span class="error" style="color:red;margin-left:5px;">This field is required</span>');
            }
            else if ($('#Compliant').val() === "No" && ($('#DueDate').val() === "NULL" || $('#DueDate').val() === "" || $('#DueDate').val() === "NaN-aN-aN" || $('#DueDate').val() === "aN/aN/NaN")) {
                $('#DueDate').after('<span class="error" style="color:red;margin-left:5px;">This field is required</span>');
            }
            else {
                        var dueDate = $('#DueDate').val();
                        if ($('#Compliant').val() === "Yes" || $('#Compliant').val() === "N/A") {
                            $('#Remarks').val("NULL");
                            $('#Severity').val("NULL");
                            $('#Assignee').val("NULL");
                            dueDate = "NULL";
                        }

                        var inspectionObj = {
                            id: $('#id').val(),
                            CompliantNo: $('#ComplaintNo').val(),
                            InspectionID: $('#InspectionID').val(),
                            Compliant: $('#Compliant').val(),
                            Remarks: $('#Remarks').val(),
                            Severity: $('#Severity').val(),
                            Assignee: $('#Assignee').val(),
                            DueDate: dueDate
                        };
               
                        $.ajax({
                            url: "/Home/UpdateInspectionResult",
                            data: JSON.stringify(inspectionObj),
                            type: "POST",
                            contentType: "application/json;charset=utf-8",
                            dataType: "json",
                            success: function (result) {

                                $("#paymentDetailList").modal('hide');
                                location.reload();
                                $('#Compliant').modal('hide');
                                $('#Remarks').val("");
                                $('#Severity').val("");
                                $('#Assignee').val("");
                                $('#DueDate').val("");
                            }
                        });
                 }
        }
    }

</script>
    